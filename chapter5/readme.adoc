= Chapter 5: Istio Service Mesh

== Introduction to Istio Service Mesh

**Slides**

. What is service mesh?
. What is Istio?
. Istio core features

== Install Istio on EKS

More details at https://aws.amazon.com/blogs/opensource/getting-started-istio-eks/[Getting Started with Istio on Amazon EKS].

**Code**

. Download Istio:

	export ISTIO_VERSION=1.0.5
	curl -L https://git.io/getLatestIstio | sh -
	cd istio-1.0.5

. Include `istio-1.*/bin` directory in `PATH`

	export PATH=`pwd`/bin:$PATH

. Helm has already been installed in a previous chapter. Install Istio on Amazon EKS:

	helm install \
		--wait \
		--name istio \
		--namespace istio-system \
		install/kubernetes/helm/istio \
		--set tracing.enabled=true \
		--set grafana.enabled=true

. Verify the list of pods:
+
	kubectl get pods -n istio-system
	NAME                                     READY   STATUS    RESTARTS   AGE
	grafana-7f6cd4bf56-nlc2k                 1/1     Running   0          1m
	istio-citadel-7dd558dcf-gtkxx            1/1     Running   0          1m
	istio-egressgateway-88887488d-w8tgx      1/1     Running   0          1m
	istio-galley-787758f7b8-s5v66            1/1     Running   0          1m
	istio-ingressgateway-58c77897cc-2ml4d    1/1     Running   0          1m
	istio-pilot-868cdfb5f7-pknvl             2/2     Running   0          1m
	istio-policy-56c4579578-vwl8v            2/2     Running   0          1m
	istio-sidecar-injector-d7f98d9cb-t6hht   1/1     Running   0          1m
	istio-telemetry-7fb48dc68b-f9qrs         2/2     Running   0          1m
	istio-tracing-7596597bd7-8gxwt           1/1     Running   0          1m
	prometheus-76db5fddd5-pp558              1/1     Running   0          1m
+
Check that both Tracing and Grafana add-ons are enabled.

== Deploy Istio-enabled Application

**Code**

. Enable `default` namespace injection:

	kubectl label namespace default istio-injection=enabled

. Talk about `istioctl` in case `default` namespace injection cannot be enabled:

	kubectl apply -f $(istioctl kube-inject -f manifest.yaml)

. Change to `manifests` directory in the repo
. Deploy the application:

	helm install --name myapp charts/myapp

. Show the list of installed apps:

	helm ls

. Check there is one deployment:

	kubectl get deployments
	NAME       DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
	greeting   1         1         1            1           31s

. Check pods and note that it has two containers (one for the application and one for the sidecar):

	kubectl get pods -l app=greeting
	NAME                       READY     STATUS    RESTARTS   AGE
	greeting-d4f55c7ff-6gz8b   2/2       Running   0          5s

. Get the list of containers in the pod:

	kubectl get pods -l app=greeting -o jsonpath={.items[*].spec.containers[*].name}
	greeting istio-proxy

. Get response:
+
  curl http://$(kubectl get svc/greeting \
  	-o jsonpath='{.status.loadBalancer.ingress[0].hostname}'):8080/hello
+
It takes about three minutes for the ELB to be ready to respond.

== Round Robin between Two Deployments

. Deploy application with two versions of `greeting`, one that returns `Hello` and another that returns `Howdy`:

  helm delete myapp --purge
  helm install --name myapp charts/myapp-hello-howdy
+
Note, there is no `type: LoadBalancer` in this case. The service will be exposed using Istio Ingress gateway so that Istio can do the traffic split.
+
. Check there are two deployments:

	kubectl get deployments
	NAME             DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
	greeting-hello   1         1         1            1           31s
	greeting-howdy   1         1         1            1           31s

. Check the list of pods:

	kubectl get pods -l app=greeting
	NAME                              READY     STATUS    RESTARTS   AGE
	greeting-hello-69cc7684d-7g4bx    2/2       Running   0          1m
	greeting-howdy-788b5d4b44-g7pml   2/2       Running   0          1m

. Create Istio resources ingress `Gateway`, `VirtualService` and `DestinationRule`:

	kubectl apply -f standalone/greeting-istio.yaml

. Check created manfiests:

	kubectl get virtualservice,destinationrule,gateway

. Get the ingress gateway address:

	$ export INGRESS_HOST=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
	$ export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="http2")].port}')

. Access application multipe times to see about 50% split between two responses:

  for i in {1..10}
  do
  	curl -q -H"Host: greeting.com" http://$INGRESS_HOST:$INGRESS_PORT/hello
  	echo
  done

== Traffic Shifting using Istio

**Code**

. Update `VirtualService` to split traffic between 90% to `Hello` and 10% to `Howdy` version of the `greeting` service.

	kubectl apply -f standalone/greeting-istio.yaml

. Invoke the service again to see the traffic split between two services:

  for i in {1..50}
  do
  	curl -q -H"Host: greeting.com" http://$INGRESS_HOST:$INGRESS_PORT/hello
  	echo
  done

== Telemetry using Istio

**Code**

. By default, Grafana is disabled. `--set grafana.enabled=true` was used during Istio installation to ensure Grafana was enabled. Alternatively, the Grafana add-on can be installed as:

	kubectl apply -f install/kubernetes/addons/grafana.yaml

. Verify:

	kubectl get pods -l app=grafana -n istio-system
	NAME                       READY     STATUS    RESTARTS   AGE
	grafana-7f6cd4bf56-nlc2k   1/1       Running   0          10m

. Forward Istio dashboard using Grafana UI:

	kubectl -n istio-system \
		port-forward $(kubectl -n istio-system \
			get pod -l app=grafana \
			-o jsonpath='{.items[0].metadata.name}') 3000:3000 &

. View Istio dashboard http://localhost:3000/d/1/istio-dashboard?
. Invoke the endpoint a few times:

	for i in {1..50}
	do
		curl -q http://$(kubectl get svc/greeting-service -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'):8080/hello
		echo
	done

. Show the Grafana dashboard:
+
image::images/istio-dashboard.png[]
